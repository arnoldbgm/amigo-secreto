{% extends 'core/base.html' %}
{% load static %}

{% block title %}Resultados | {{ room.code }}{% endblock %}

{% block content %}
<div class="mb-8">
    <h1 class="text-4xl font-bold text-slate-900">
        <i class="bi bi-trophy-fill text-yellow-500 mr-2"></i>Resultados Finales
    </h1>
    <p class="mt-1 text-lg text-slate-600">
        Descubre quién fue el mejor predictor y las asignaciones del Amigo Secreto en la sala <strong class="font-semibold text-slate-800">{{ room.code }}</strong>.
    </p>
</div>

<!-- Messages -->
{% if messages %}
<div class="mb-6 w-full">
    {% for message in messages %}
        {% if 'error' in message.tags %}
        <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded-lg shadow-md mb-2" role="alert">
            <div class="flex">
                <div class="py-1"><i class="bi bi-exclamation-triangle-fill mr-3 text-xl"></i></div>
                <div>
                    <p class="font-bold">Error</p>
                    <p class="text-sm">{{ message }}</p>
                </div>
            </div>
        </div>
        {% elif 'warning' in message.tags %}
        <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-md mb-2" role="alert">
            <div class="flex">
                <div class="py-1"><i class="bi bi-exclamation-circle-fill mr-3 text-xl"></i></div>
                <div>
                    <p class="font-bold">Atención</p>
                    <p class="text-sm">{{ message }}</p>
                </div>
            </div>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% endif %}

{% if room.status != room.STATUS_RESULTS %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg shadow-md mb-6" role="alert">
        <div class="flex">
            <div class="py-1"><i class="bi bi-info-circle-fill mr-3 text-xl"></i></div>
            <div>
                <p class="font-bold">Resultados Pendientes</p>
                <p class="text-sm">El administrador aún no ha habilitado los resultados para esta sala. ¡Paciencia!</p>
            </div>
        </div>
    </div>
{% else %}
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
        <!-- Ranking de Predicciones -->
        <div class="bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center">
                <i class="bi bi-card-list mr-3 text-blue-600"></i>Ranking de Predicciones
            </h2>
            {% if ranking %}
                <div class="space-y-2">
                    {% for name, data in ranking %}
                        <div>
                            <div class="user-prediction-toggle flex items-center text-lg p-3 rounded-lg cursor-pointer transition-colors hover:bg-slate-100 {% if name in winners %}bg-green-50 text-green-700 font-bold{% else %}text-slate-700{% endif %}">
                                {% if name in winners %}
                                    <i class="bi bi-award-fill text-yellow-500 mr-3"></i>
                                {% else %}
                                    <i class="bi bi-person-fill mr-3"></i>
                                {% endif %}
                                {{ name }}
                                <span class="ml-auto bg-blue-100 text-blue-800 text-sm font-semibold mr-2 px-2.5 py-0.5 rounded-full">{{ data.score }} acierto{% if data.score != 1 %}s{% endif %}</span>
                                <i class="bi bi-chevron-down toggle-icon transition-transform"></i>
                            </div>
                            <div class="user-predictions-list hidden pl-8 pr-4 py-2 bg-slate-50 rounded-b-lg border-l-4 border-slate-200">
                                {% if data.predictions %}
                                    <ul class="space-y-2 mt-2">
                                        {% for prediction in data.predictions %}
                                            <li class="p-2 rounded-lg text-sm {% if prediction.is_correct %}bg-green-100 text-green-800{% else %}bg-red-100 text-red-800{% endif %}">
                                                Predijo que <strong>{{ prediction.predicted_giver }}</strong> regala a <strong>{{ prediction.predicted_receiver }}</strong>
                                            </li>
                                        {% endfor %}
                                    </ul>
                                {% else %}
                                    <p class="text-sm text-slate-500 italic">Este usuario no hizo predicciones.</p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                <div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg text-center">
                    {% if winners|length == 1 %}
                        <p class="text-xl font-bold text-blue-700">¡El ganador es <span class="text-green-600">{{ winners.0 }}</span>!</p>
                        <p class="text-blue-600">Con {{ ranking.0.1.score }} acierto{% if ranking.0.1.score != 1 %}s{% endif %}.</p>
                    {% else %}
                        <p class="text-xl font-bold text-blue-700">¡Hay un empate!</p>
                        <p class="text-blue-600">Entre: {% for winner in winners %}<span class="text-green-600">{{ winner }}</span>{% if not forloop.last %}, {% endif %}{% endfor %} con {{ ranking.0.1.score }} acierto{% if ranking.0.1.score != 1 %}s{% endif %}.</p>
                    {% endif %}
                </div>
            {% else %}
                <p class="text-slate-500 text-lg">No hay predicciones registradas para esta sala.</p>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const toggles = document.querySelectorAll('.user-prediction-toggle');
            toggles.forEach(toggle => {
                toggle.addEventListener('click', function() {
                    const predictionsList = this.nextElementSibling;
                    const icon = this.querySelector('.toggle-icon');
                    
                    predictionsList.classList.toggle('hidden');
                    icon.classList.toggle('rotate-180');
                });
            });
        });
    </script>
        <!-- Sorteo Real -->
        <div class="mt-8 bg-white p-6 rounded-2xl shadow-lg">
            <h2 class="text-2xl font-bold text-slate-800 mb-4 flex items-center">
                <i class="bi bi-gift-fill mr-3 text-red-500"></i>El Amigo Secreto Real
            </h2>
            {% if actual_assignments %}
                <ul class="divide-y divide-slate-200">
                    {% for assignment in actual_assignments %}
                        <li class="flex items-center py-3 text-lg text-slate-700">
                            <i class="bi bi-arrow-right-circle-fill mr-3 text-blue-500"></i>
                            <span class="font-semibold">{{ assignment.giver }}</span> le regala a <span class="font-semibold">{{ assignment.receiver }}</span>
                        </li>
                    {% endfor %}
                </ul>
            {% else %}
                <p class="text-slate-500 text-lg">El sorteo real aún no se ha generado o no hay asignaciones para mostrar.</p>
            {% endif %}
            {% if not show_actual_assignments %}
            <div class="mt-6 p-4 bg-slate-100 border border-slate-200 rounded-lg text-center text-slate-600">
                <p><i class="bi bi-eye-slash-fill mr-2"></i>Solo el administrador puede ver el detalle completo del sorteo.</p>
            </div>
            {% endif %}
        </div>
    </div>

{% endif %}
{% endblock %}